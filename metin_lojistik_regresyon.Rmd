---
title: "Lojistik Regresyon"
author: "Merve Akküp"
date: '2022-05-16'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Giriş

Bu çalışmada, programda mevcut olan Smarket veri seti (borsa ile alakalı veriler bulunmaktadır) üzerinden lojistik regresyon testi gerçekleştirilmiştir. Mevcut borsa verileri kullanılarak model oluşturulup tahminler yapılacaktır ve bu tahminlerin güvenilirliği test edilecektir.
Öncelikle veri setinin olduğu kütüphaneyi çağıralım:

```{r}
library(ISLR2)
```

Smarket veri setini inceleyelim ve veri setini daha rahat çalışabilmek adına attach fonksiyonu ile R çevresine bağlayalım:

```{r}
colnames(Smarket)

dim(Smarket)

summary(Smarket)

attach(Smarket)
```

Burada `attach` fonksiyonu ile verimizi R çevresine bağlayabiliyoruz. Bu sayede, veri çerçevesi içindeki sütun isimlerine doğrudan erişebiliriz.

Bu modelleme çalışmasındaki amacımız, borsanın o günkü seyrini (`Direction` değişkeni), son beş gün boyunca borsa kapanışı ve o günkü alış satış hacmini kullanarak tahmin etmeye çalışıyoruz.

Verilerle bir model oluşturalım. modeli setteki Directionc verisine göre kurup, modelin özetini inceleyelim, modele, modeli tanımlayacak bir isim atayarak glm fonksiyonu ile oluşturduk.

```{r}
glm.fits <- glm(data = Smarket, Direction~Lag1 + Lag2 +Lag3+ Lag4+ Lag5+ Volume, family = binomial)
summary(glm.fits)
```

Predict fonksiyonu ile modelimizin ilk 10 parametresini tahmin edelim:

```{r}
predict(glm.fits, type = "response")[1:10]
```

Tahminleri, yeni bir veri içine aktaralım, bu şekilde yeni verimizle sadece tahmin üzerinden işlem yapabiliriz.

Öncelikle, tahmin ettiğimiz Direction verilerinin olasılık değerlerini alalım:

```{r}
glm_prob <- predict(glm.fits, type = "response")
```

Yeni oluşturduğumuz tahmin veri setinin ilk 6 elemanını inceleyelim:

```{r}
head(glm_prob)
```

Ve tahmin veri setimizin histogramını oluşturduktan sonra, tahmin veri seti için olasılık veri seti oluşturalım: 

```{r}
hist(glm_prob)
```

Sadece histograma baktığımızda, tahmin verilerimizin bir bölgede gruplandığını görebiliriz. Bu bölgeyi sınır noktası olarak kabul ederek çalışmayı 1-0 moduna indirgeyebiliriz. Bu şekilde pozitif ve negatif sonuçlar alabiliriz. sum fonksiyonu ile 0.5 olarak kabul ettiğimiz ayrımın altında ve üstünde kalan değerlerin sayısını inceleyelim. Bunların hepsi toplandığında, dim fonksiyonu ile incelediğimiz veri seti boyutunu elde etmemiz gerekir. 

Kaç tane tahmin olaslığı 0.5'den büyük?

```{r}
sum(glm_prob > 0.5)
```

Kaç tanesi 0.5'den küçük?

```{r}
sum(glm_prob < 0.5)
```

Şimdi aynı histogramın, 0.5 değerini çizgi ile gösteren versiyonunu oluşturalım:


```{r}
glm_pred <- predict(glm.fits, type = "response")

hist(glm_pred)

abline(v=0.5, col="red", lwd=10)
```

Şimdi bu değerleri, ''aşağı ve yukarı'' olarak tanımlayalım.

```{r}

glm_pred<- rep("Down", 1250)

glm_pred[glm_prob> 0.5]  <- "up"

```

Şimdi bu tanımlanan değerlerin table fonksiyonu ile frekans tablosunu oluşturup sağlamasını yapalım: 

```{r}
table(glm_pred)
```

Veri seti içindeki herhangi bir verinin aşağı ve yukarı olarak nasıl gösterilebileceğine bakalım, burada Direction verisinin ilk 5 satırı incelenmiştir. Down olarak gösterilenler 0.5'ten küçük, up olarak gösterilenler ise 0.5'ten büyük olan değerlerdir.

Peki, gerçek değerlerimiz nedir?

```{r}
Smarket$Direction[1:5]
```

Şimdi ise, hem gerçek hem de tahmin edilmiş değerlerden bir karmaşa matrisi oluşturalım:

```{r}
table(Smarket$Direction, glm_pred)
```

Az önce incelediğimiz verinin frekans tablosuna bakalım.Artık burası çalışmanın kilit noktasıdır. Oluşturduğumuz tablo, karmaşa matriksi/confussion matrix olarak bilinmektedir ve bu matriks, test kitinden alınan değerlerin ve laboratuvar sonuçlarının karşılaştırılmasını sağlar.Burada testin güvenilirliğini gösteren nokta,up-up ve down-down değerlerinin yüksekliğidir.

Bu veri setinde borsa değerleri vardı ve borsadaki düşüşleri ve yükselişleri temsil etmek adına ölçümlerimizi up ve down olarak tanımladık. Bu tanımları istediğimiz şekilde  yapabiliriz, eğer hastalık tanı kitiyse hasta-sağlıklı gibi...
Pozitif ve negatiften (1-0) bahsetmiştik. Karmaşa matriksinde bu değerlerin temsil ettiği durumlar şu şekildedir:

True Positive/Gerçek Pozitif: Eğer test kitimizden aldığımız pozitifler, laboratuvar çalışmalarında da pozitif çıktıysa gerçekten pozitiftir.

True Negative/Gerçek Negatif: Eğer test kitimizden aldığımız negatifler, laboratuvar çalışmalarında da negatif çıktıysa gerçekten negatiftir.

False Posivite/Hatalı Pozitif: Eğer test kitimizden aldığımız sonuçlar pozitifse fakat laboratuvarda bu sonuçlar negatif çıkmışsa, yanlış pozitif değerler elde etmiş oluruz.

False Negative/Hatalı Negatif: Eğer test kitimizden aldığımız negatif sonuçlar laboratuvarda pozitif olarak çıkmışsa, yanlış negatif değerler elde etmişiz demektir.

Bir takım basit matematiksel formüllerle bu değer oranlarına bakılarak veri seti üzerinde oluşturulan modellerin güvenilirliği incelenebilir.Örneğin:

accuracy(güvenilirlik)=(TruePositive+TrueNegative)/Toplam veri 
error(hata)=1-accuracy

Peki bu öğrendiklerimizi neye ölçekleyebiliriz?

Yeni bir hastalık tanı kiti oluşturduğumuzu düşünelim ve bu kitin performansını test etmek istiyoruz.

Sizce ne yapabiliriz? İlk olarak hasta ve sağlıklı olduklarından emin olduğumuz bir grup kişi ile çalışmaya başlayabiliriz. Sonra bu kişilerden alınan örnekleri, geliştirdiğimiz kit ile test ederek bir tahmin elde edebiliriz.

Elde edeceğimiz sonuç ya hasta ya da sağlıklı olacaktır. 

Amacımız sizce ne olabilir? Mantık olarak; gerçekten hasta olan kişileri hasta olarak, gerçekten sağlıklı olan kişileri de sağlıklı olarak tahmin edebiliyorsak kitimiz doğru çalışıyor demektir.

